> åŸæ–‡é“¾æ¥: https://kerkour.com/rust-functional-programming
>
> **ç¿»è¯‘ï¼š[æœ•ä¸å°†å†›è§£æˆ˜è¢](https://github.com/a1393323447)**
>
> é€‰é¢˜ï¼š[æœ•ä¸å°†å†›è§£æˆ˜è¢](https://github.com/a1393323447)
>
> æœ¬æ–‡ç”± [Rustt](https://Rustt.org) ç¿»è¯‘ï¼Œ[StudyRust](https://studyrust.org) è£èª‰æ¨å‡º

# Rust ä¸­çš„å‡½æ•°å¼ç¼–ç¨‹

åœ¨ä¸Šå¤§å­¦æ—¶ï¼Œä¸€ä½[æœ‹å‹](https://yanael.io/)ç»™æˆ‘ä»‹ç»äº† Haskell ï¼Œè‡ªé‚£ä¹‹åï¼Œæˆ‘ä¸€ç›´å¯¹å‡½æ•°å¼ç¼–ç¨‹æ„Ÿå…´è¶£ã€‚

å› ä¸º Haskell å’Œæˆ‘ç°åœ¨ç”¨çš„è¯­è¨€ï¼ˆC å’Œ Node.jsï¼‰å·®åˆ«å¤ªå¤§ï¼Œå¯¼è‡´æˆ‘ä»æ¥æ²¡æœ‰çœŸæ­£å­¦ä¼šå®ƒã€‚è€Œä¸€é—¨æ–°çš„ç¼–ç¨‹è¯­è¨€å®Œç¾åœ°å…¼å®¹äº†å‘½ä»¤å¼å’Œå‡½æ•°å¼ç¼–ç¨‹ï¼Œç”šè‡³è®©â€œæœ€é¢å‘å¯¹è±¡çš„â€ç¨‹åºå‘˜éƒ½èƒ½åœ¨ä»–ä»¬çš„ä»£ç é‡Œæ·»åŠ ä¸€ç‚¹â€œå‡½æ•°å¼ç¼–ç¨‹èŒƒå¼â€å¹¶ä¸”å‡å°‘ bug ã€‚å†å’Œè¿™é—¨è¯­è¨€å…ˆè¿›çš„ç±»å‹ç³»ç»Ÿç»“åˆåœ¨ä¸€èµ·ï¼Œç¼–å†™ä»£ç ä¸­çš„ä¸å˜é‡ä¹Ÿå˜å¾—ç®€å•ã€‚

ä½ æ„è¯†åˆ°äº†ï¼Œæˆ‘ä»¬è®¨è®ºçš„æ˜¯ Rust ã€‚

> è¿™ç¯‡æ–‡ç« æ‘˜å½•è‡ªæˆ‘çš„ä¹¦ [ã€ŠBlack Hat Rustã€‹](https://kerkour.com/black-hat-rust) ï¼Œä½ å¯ä»¥ä»è¿™æœ¬ä¹¦å­¦åˆ° Rustã€è¿›æ”»æ€§å®‰å…¨ï¼ˆoffensive securityï¼‰å’Œå¯†ç å­¦ã€‚

## ä¸ºä»€ä¹ˆ

å‡½æ•°å¼ç¼–ç¨‹çš„æ ¸å¿ƒå‰ææ˜¯é€šè¿‡å£°æ˜ä»£æ›¿å‘½ä»¤æ¥å‡å°‘ bug ã€‚

æ„å»ºä¸€äº›ä½œä¸ºè¡¨è¾¾å¼çš„ä»£ç å—ï¼Œè€Œä¸æ˜¯åƒåœ¨å‘½ä»¤å¼ç¼–ç¨‹é‡Œé‚£æ ·ä½œä¸ºè¯­å¥ã€‚ä¾‹å¦‚ï¼Œåœ¨ [Lisp](https://en.wikipedia.org/wiki/Lisp_(programming_language)) é‡Œä¸‡ç‰©çš†è¡¨è¾¾å¼ã€‚å¦ä¸€æ–¹é¢ï¼Œ C è¯­è¨€å¤§å¤šæ•°ä»£ç å—éƒ½æ˜¯è¯­å¥ã€‚Rust æ€»çš„æ¥è¯´æ˜¯ä¸€é—¨è¡¨è¾¾å¼è¯­è¨€ï¼šå¤§å¤šæ•°ä»£ç å—éƒ½äº§ç”Ÿå€¼ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä½ å¯ä»¥ç”¨

```rust
fn add_one(x: u64) -> u64 {
  x + 1
}
```

ä»£æ›¿

```rust
fn add_one(x: u64) -> u64 {
  return x + 1;
}
```

å‡½æ•°å¼ç¼–ç¨‹çš„ç¬¬äºŒä¸ªé‡è¦æ–¹é¢æ˜¯å¯¹ä¸å¯å˜æ•°æ®çš„å½±å“ã€‚

ç¬¬ä¸‰ï¼Œç”±äºæ˜¯å£°æ˜å¼ï¼Œå‡½æ•°å¼ç¼–ç¨‹è¢«è®¤ä¸ºæ›´æ¥è¿‘äººç±»ï¼ˆæ•°å­¦ï¼‰æ€ç»´ï¼Œå› æ­¤æ›´å®¹æ˜“è¢«ç†è§£ã€‚

æœ€åä¸€ä¸ªæœ‰äº‰è®®çš„ç‚¹æ˜¯ï¼Œå› ä¸ºå¤§å¤šæ•°ç¨‹åºå‘˜åœ¨è®­ç»ƒçš„æ—¶å€™å­¦ä¹ çš„æ˜¯å‘½ä»¤å¼å’Œé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼Œæ‰€ä»¥å‡½æ•°å¼ç¼–ç¨‹æ–¹å¼åœ¨æŸç§ç¨‹åº¦ä¸Šè¦æ±‚ä»–ä»¬é‡æ–°å­¦ä¹ å¦‚ä½•ç¼–ç¨‹ã€‚

## ä¸å˜æ€§

Rust çš„å˜é‡éƒ½æ˜¯é»˜è®¤ä¸å˜çš„ã€‚å½“ä½ æƒ³è¦ä¸€ä¸ªå¯å˜å˜é‡æ—¶ï¼Œä½ éœ€è¦æ˜¾å¼å£°æ˜ã€‚

```rust
fn main() {
    let mut v = Vec::new();

    push_forty_two(&mut v)
}

fn push_forty_two(v: &mut Vec<u64>) {
    v.push(42);
}
```

ä½†æ˜¯ï¼Œä¸‹é¢çš„ä»£ç 

```rust
fn main() {
    let v = Vec::new();

    push_forty_two(&mut v)
}

fn push_forty_two(v: &mut Vec<u64>) {
    v.push(42);
}
```

ä¸èƒ½é€šè¿‡ç¼–è¯‘

```
   Compiling playground v0.0.1 (/playground)
error[E0596]: cannot borrow `v` as mutable, as it is not declared as mutable
 --> src/main.rs:4:20
  |
2 |     let v = Vec::new();
  |         - help: consider changing this to be mutable: `mut v`
3 |
4 |     push_forty_two(&mut v)
  |                    ^^^^^^ cannot borrow as mutable

For more information about this error, try `rustc --explain E0596`.
error: could not compile `playground` due to previous error
```

## å‡½æ•°æ˜¯ä¸€ç­‰å…¬æ°‘

å¹¸äºæœ‰  [Fn](https://doc.rust-lang.org/stable/std/ops/trait.Fn.html)ã€ [FnMut](https://doc.rust-lang.org/stable/std/ops/trait.FnMut.html) å’Œ [FnOnce](https://doc.rust-lang.org/stable/std/ops/trait.FnOnce.html) è¿™äº› trait ï¼Œæˆ‘ä»¬å¯ä»¥åƒå¤„ç†å…¶ä»–ç±»å‹çš„å˜é‡é‚£æ ·å¤„ç†å‡½æ•°ã€‚

- *`Fn` çš„å®ä¾‹åœ¨æ²¡æœ‰çŠ¶æ€æ”¹å˜çš„æƒ…å†µä¸‹å¯ä»¥è¢«é‡å¤è°ƒç”¨ã€‚*
- *`FnMut` çš„å®ä¾‹åœ¨å¯èƒ½æœ‰çŠ¶æ€æ”¹å˜çš„æƒ…å†µä¸‹å¯ä»¥è¢«é‡å¤è°ƒç”¨ã€‚*
- *`FnOnce` çš„å®ä¾‹å¯ä»¥è¢«è°ƒç”¨ï¼Œä½†å¯èƒ½ä¸èƒ½è¢«å¤šæ¬¡è°ƒç”¨ã€‚å› æ­¤ï¼Œå¦‚æœåªçŸ¥é“ä¸€ç§ç±»å‹å®ç°äº† `FnOnce` ï¼Œé‚£ä¹ˆå®ƒåªèƒ½è¢«è°ƒç”¨ä¸€æ¬¡ã€‚*

```rust
fn apply<F: Fn(&str)>(x: &[&str], f: F) {
    for elem in x {
      f(&elem)
    }
}

fn main() {
  let v = vec!["hello", "world"];
  apply(&v, |x| println!("{}", x));
}
```

åœ¨ *The Rust Programming Language* è¿™æœ¬ä¹¦ä¸­çš„[å…³äºé—­åŒ…çš„ç« èŠ‚](https://doc.rust-lang.org/stable/book/ch13-01-closures.html)é‡Œï¼Œä½ å¯ä»¥å­¦åˆ°æ›´å¤šå’Œè¿™ä¸ªè¯é¢˜æœ‰å…³çš„çŸ¥è¯†ã€‚

## è¿­ä»£å™¨å’Œç»„åˆå­

`Iterator` æ˜¯ä¸€ç§å…è®¸å¼€å‘äººå‘˜éå†é›†åˆçš„å¯¹è±¡ã€‚

æ ‡å‡†åº“çš„å¤§å¤šæ•°é›†åˆéƒ½èƒ½æä¾›è¿­ä»£å™¨ã€‚

é¦–å…ˆï¼Œ`into_iter` æä¾›äº†ä¸€ä¸ªæ‹¥æœ‰æ‰€æœ‰æƒçš„è¿­ä»£å™¨ï¼šé›†åˆè¢«ç§»åŠ¨äº†ï¼Œä½ å†ä¹Ÿä¸èƒ½ä½¿ç”¨åŸæ¥çš„å˜é‡äº†ã€‚

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn vector() {
    let v = vec![
        1, 2, 3,
    ];

    for x in v.into_iter() {
        println!("{}", x);
    }

    // ä½ å†ä¹Ÿä¸èƒ½ä½¿ç”¨ v
}
```

ç„¶åï¼Œ`iter` æä¾›äº†ä¸€ä¸ªå€Ÿç”¨çš„è¿­ä»£å™¨ã€‚ä¸‹é¢ä»£ç ä¸­çš„å˜é‡ `key` å’Œ `value` éƒ½æ˜¯å¼•ç”¨ï¼ˆè¿™ä¸ªä¾‹å­ä¸­æ˜¯ `&String` ï¼‰ã€‚

```rust
fn hashmap() {
    let mut h = HashMap::new();
    h.insert(String::from("Hello"), String::from("World"));

    for (key, value) in h.iter() {
        println!("{}: {}", key, value);
    }
}
```

åœ¨ 1.53ï¼ˆå‘å¸ƒäº 2021-06-17ï¼‰åï¼Œæ•°ç»„ä¹Ÿå¯ä»¥æä¾›è¿­ä»£å™¨ï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn array() {
    let a =[
        1, 2, 3,
    ];

    for x in a.iter() {
        println!("{}", x);
    }
}
```

### ä½¿ç”¨è¿­ä»£å™¨

è¿­ä»£å™¨æ˜¯æƒ°æ€§çš„ï¼ˆlazyï¼‰ï¼šåœ¨è¢«ä½¿ç”¨å‰ä»€ä¹ˆéƒ½ä¸ä¼šåšã€‚

æ­£å¦‚åˆšæ‰æ‰€è§ï¼Œè¿­ä»£å™¨å¯ä»¥åœ¨ `for x in` å¾ªç¯ä¸­è¢«ä½¿ç”¨ã€‚ä½†è¿™ä¸æ˜¯æœ€å¸¸ç”¨çš„åœ°æ–¹ã€‚åœ°é“çš„ Rust æ›´å–œæ¬¢å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼ã€‚

[for_each](https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.for_each) æ˜¯ä¸€ä¸ªç­‰ä»·äº `for .. in ..` å¾ªç¯çš„å‡½æ•°ï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn for_each() {
    let v = vec!["Hello", "World", "!"].into_iter();

    v.for_each(|word| {
        println!("{}", word);
    });
}
```

[collect](https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.collect) å¯ä»¥ç”¨æ¥å°†ä¸€ä¸ªè¿­ä»£å™¨è½¬åŒ–æˆä¸€ä¸ªé›†åˆï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn collect() {
    let x = vec![1, 2, 3, 4, 5, 6, 7, 8, 9, 10].into_iter();

    let _: Vec<u64> = x.collect();
}
```

åè¿‡æ¥ï¼Œä½ å¯ä»¥é€šè¿‡ä½¿ç”¨ `from_iter` è·å¾— `HashMap` ï¼ˆæˆ–è€… `BTreeMap`ï¼Œæˆ–è€…å…¶å®ƒé›†åˆï¼Œå¯ä»¥æŸ¥é˜…ï¼šhttps://doc.rust-lang.org/std/iter/trait.FromIterator.html#implementorsï¼‰:

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn from_iter() {
    let x = vec![(1, 2), (3, 4), (5, 6)].into_iter();

    let _: HashMap<u64, u64> = HashMap::from_iter(x);
}
```

[reduce](https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.reduce) å¯ä»¥ä½¿ç”¨é—­åŒ…åœ¨è¿­ä»£å™¨ä¸Šè¿›è¡Œç´¯ç§¯ï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn reduce() {
    let values = vec![1, 2, 3, 4, 5].into_iter();

    let _sum = values.reduce(|acc, x| acc + x);
}
```

ä¸Šé¢çš„ `_sum` = 1 + 2 + 3 + 4 + 5 = 15

[fold](https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.fold) å’Œ `reduce` ç±»ä¼¼ï¼Œä½†å®ƒå¯ä»¥è¿”å›ä¸€ä¸ªå’Œè¿­ä»£å™¨ä¸­çš„å…ƒç´ ç±»å‹ä¸åŒçš„ç´¯ç§¯é‡ï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn fold() {
    let values = vec!["Hello", "World", "!"].into_iter();

    let _sentence = values.fold(String::new(), |acc, x| acc + x);
}
```

ä¸Šé¢çš„ `_sentence` çš„ç±»å‹æ˜¯ `String` ï¼Œè€Œè¿­ä»£å™¨é‡Œçš„å…ƒç´ ç±»å‹æ˜¯ `&str `ã€‚

### å¹¶è¡Œè¿­ä»£å™¨

é€šå¸¸ï¼Œç”±äºææœ‰å¯èƒ½å¼•å…¥åˆšæ‰çœ‹åˆ°çš„ bug ï¼Œå¼€å‘äººå‘˜éƒ½å¯¹å¤šçº¿ç¨‹æ„Ÿåˆ°å®³æ€•ã€‚

ä½†åœ¨ Rust é‡Œå°±æ˜¯å¦ä¸€ä¸ªåœºæ™¯äº†ã€‚é™¤äº†å¯åŠ¨é•¿æ—¶é—´è¿è¡Œçš„åå°ä½œä¸šæˆ– worker å¤–ï¼Œ**å¾ˆå°‘ä¼šç›´æ¥ä½¿ç”¨æ ‡å‡†åº“ä¸­çš„çº¿ç¨‹API**ã€‚

ä½œä¸ºæ›¿ä»£ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯  [rayon](https://github.com/rayon-rs/rayon)ï¼Œ*ä¸€ä¸ª Rust çš„æ•°æ®å¹¶è¡Œï¼ˆdata-parallelismï¼‰åº“*ã€‚

ä¸ºä»€ä¹ˆéœ€è¦ä¸€ä¸ªæ•°æ®å¹¶è¡Œåº“ï¼Ÿå› ä¸ºçº¿ç¨‹åŒæ­¥å¾ˆéš¾ã€‚æœ€å¥½é€šè¿‡ä¸éœ€è¦åŒæ­¥çº¿ç¨‹çš„å‡½æ•°å¼æ¥è®¾è®¡ç¨‹åºã€‚

**[ch_02/tricoder/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_02/tricoder/src/main.rs)**

```rust
// ...
use rayon::prelude::*;

fn main() -> Result<()> {
    // ...
    let scan_result: Vec<Subdomain> = subdomains::enumerate(&http_client, target)
        .unwrap()
        .into_par_iter()
        .map(ports::scan_ports)
        .collect();
    // ...
}
```

ç„¶â€”â€”å... ... è¿™å°±æ˜¯æ‰€æœ‰çš„ä»£ç äº†ã€‚çœŸçš„ï¼Œæ²¡éª—ä½ ã€‚åªéœ€è¦æŠŠ `into_iter()` æ¢æˆ `into_par_iter()` ï¼ˆè¡¨ç¤ºâ€œinto parallel iteratorâ€ï¼Œå³â€œè½¬æ¢ä¸ºå¹¶è¡Œè¿­ä»£å™¨â€ï¼‰ã€‚

### ç»„åˆå­

ç»„åˆå­æ˜¯ä¸€ä¸ªååˆ†æœ‰è¶£çš„è¯é¢˜ã€‚å‡ ä¹æ‰€æœ‰ä½ èƒ½åœ¨ç½‘ä¸Šæ‰¾åˆ°çš„å®šä¹‰éƒ½ä¼šè®©ä½ çš„å¤§è„‘çˆ†ç‚¸ ğŸ¤¯ ï¼Œå› ä¸ºå®ƒä»¬å¸¦æ¥çš„ç–‘é—®æ¯”è§£ç­”çš„å¤šã€‚

æ‰€ä»¥ï¼Œæˆ‘ç»™å‡ºä¸€ä¸ªç»éªŒå®šä¹‰ï¼šç»„åˆå­æ˜¯ä¸€ç§ç®€åŒ–ç±»å‹ `T` çš„æ“ä½œçš„æ–¹æ³•ã€‚å®ƒä»¬æ›´å€¾å‘äºå‡½æ•°å¼ï¼ˆé“¾å¼è°ƒç”¨ï¼‰çš„é£æ ¼çš„ä»£ç ã€‚

```rust
let sum: u64 = vec![1, 2, 3].into_iter().map(|x| x * x).sum();
```

è¿™ä¸€èŠ‚æ˜¯ä¸€äº›â€œå‘Šè¯‰ä½ æ€ä¹ˆæ ·åšâ€çš„ã€â€œçœŸå®â€çš„èŒƒä¾‹ï¼Œå®ƒä»¬ä¼šå‘ä½ å±•ç¤ºå¦‚ä½•é€šè¿‡ç»„åˆå­è®©ä½ çš„ä»£ç æ›´å®¹æ˜“é˜…è¯»æˆ–é‡æ„ã€‚

é¦–å…ˆï¼Œè¿™æ˜¯æœ€è‘—åçš„ã€å‡ ä¹åœ¨æ‰€æœ‰è¯­è¨€éƒ½å¯ä»¥ä½¿ç”¨çš„ï¼š[filter](https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.filter)ï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn filter() {
    let v = vec![-1, 2, -3, 4, 5].into_iter();

    let _positive_numbers: Vec<i32> = v.filter(|x: &i32| x.is_positive()).collect();
}
```

[inspect](https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.inspect) å¯ä»¥ç”¨äº... è§‚å¯Ÿæ‰€æœ‰ç»è¿‡è¿­ä»£å™¨çš„å€¼ï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn inspect() {
    let v = vec![-1, 2, -3, 4, 5].into_iter();

    let _positive_numbers: Vec<i32> = v
        .inspect(|x| println!("Before filter: {}", x))
        .filter(|x: &i32| x.is_positive())
        .inspect(|x| println!("After filter: {}", x))
        .collect();
}
```

[map](https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.map) ç”¨äºå°†è¿­ä»£å™¨ä¸­çš„å…ƒç´ ä»ä¸€ç§ç±»å‹è½¬æ¢ä¸ºå¦ä¸€ç§ç±»å‹ï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn map() {
    let v = vec!["Hello", "World", "!"].into_iter();

    let w: Vec<String> = v.map(String::from).collect();
}
```

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå…ƒç´ ç±»å‹ä» `&str` å˜ä¸ºäº† `String` ã€‚

[filter_map](https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.filter_map) æœ‰ç‚¹åƒ `map` å’Œ `filter` çš„ç»„åˆã€‚å®ƒåœ¨å¤„ç† `Option` è€Œä¸æ˜¯ `bool` çš„æ—¶å€™æœ‰ä¼˜åŠ¿ï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn filter_map() {
    let v = vec!["Hello", "World", "!"].into_iter();

    let w: Vec<String> = v
        .filter_map(|x| {
            if x.len() > 2 {
                Some(String::from(x))
            } else {
                None
            }
        })
        .collect();

    assert_eq!(w, vec!["Hello".to_string(), "World".to_string()]);
}
```

[chain](https://doc.rust-lang.org/std/iter/trait.Iterator.html#method.chain) ç”¨äºåˆå¹¶ä¸¤ä¸ªè¿­ä»£å™¨ï¼š

**[ch_03/snippets/combinators/src/main.rs](https://github.com/skerkour/black-hat-rust/blob/main/ch_03/snippets/combinators/src/main.rs)**

```rust
fn chain() {
    let x = vec![1, 2, 3, 4, 5].into_iter();
    let y = vec![6, 7, 8, 9, 10].into_iter();

    let z: Vec<u64> = x.chain(y).collect();
    assert_eq!(z.len(), 10);
}
```

è¿˜æœ‰å¾ˆå¤šå…¶å®ƒçš„ç»„åˆå­... ...

## ä»£æ•°æ•°æ®ç±»å‹å’Œæ¨¡å¼åŒ¹é…

æšä¸¾æ— ç–‘æ˜¯æ–° Rustacean æœ€å–œæ¬¢çš„ç‰¹æ€§ï¼Œå› ä¸ºå®ƒæ˜¯ `Result` å’Œ `Option` çš„åŸºç¡€ã€‚æšä¸¾è®©æˆ‘ä»¬è¡¨ç¤ºåŸŸï¼ˆdomainï¼‰ä¸­æ‰€æœ‰ä¸å˜é‡ï¼Œå¹¶åœ¨ç¼–è¯‘æ—¶æ£€æŸ¥æ˜¯å¦æ¶µç›–äº†æ‰€æœ‰æƒ…å†µã€‚

ä½ å¯ä»¥ä½¿ç”¨ `match` å…³é”®å­—å¯¹æšä¸¾è¿›è¡Œæ¨¡å¼åŒ¹é…ã€‚

```rust
#[derive(Debug, Clone, Copy)]
enum Platform {
    Linux,
    MacOS,
    Windows,
    Unknown,
}

impl fmt::Display for Platform {
    fn fmt(&self, f: &mut fmt::Formatter) -> fmt::Result {
        match self {
            Platform::Linux => write!(f, "Linux"),
            Platform::Macos => write!(f, "macOS"),
            // ç¼–è¯‘æ—¶é”™è¯¯ï¼æˆ‘ä»¬é—æ¼äº† Windows å’Œ Unknown 
        }
    }
}
```

ä½†è¿™è¿˜ä¸æ˜¯å…¨éƒ¨ã€‚Rust ä¸­çš„æ¨¡å¼åŒ¹é…è¿˜å¯ä»¥ç”¨æ¥åŒ¹é…è®¸å¤šå…¶ä»–çš„è¡¨è¾¾å¼ï¼š

```rust
match x {
    42 => println!("Good!"),
    _ => println!("Bad!"),
}

let boolean = true;
// match ä¹Ÿæ˜¯ä¸€ä¸ªè¡¨è¾¾å¼
let binary = match boolean {
    false => 0,
    true => 1,
};


let x = Some(42u64);

match x {
    Some(1) => println!("1"),
    Some(42) => println!("42"),
    None => println!("none"),
};
```

## æµ

æµæ˜¯ `async` è¯­å¢ƒä¸‹çš„è¿­ä»£å™¨ã€‚

**ä½ åº”å½“åœ¨æƒ³è¦å¯¹ä¸€ç³»åˆ—å…ƒç´ è¿›è¡Œå¼‚æ­¥æ“ä½œæ—¶ä½¿ç”¨æµã€‚**

å¯ä»¥æ˜¯ä¸€ä¸ªç½‘ç»œ socketï¼Œä¸€ä¸ªæ–‡ä»¶ï¼Œä¸€ä¸ªæŒä¹…çš„ï¼ˆlong-livedï¼‰HTTP è¯·æ±‚ã€‚

ä»»ä½•å› ä¸ºå¤ªå¤§è€Œè¦è¢«åˆ†ä¸ºæ›´å°å—çš„ï¼Œæˆ–è€…åœ¨å°†æ¥æŸä¸ªæˆ‘ä»¬ä¸çŸ¥é“çš„æ—¶é—´ç‚¹åˆ°è¾¾çš„ä¸œè¥¿ï¼Œæˆ–è€…åªæ˜¯ä¸€ä¸ªæˆ‘ä»¬æƒ³è¦åœ¨ä¸Šé¢æ‰§è¡Œ `å¼‚æ­¥` æ“ä½œçš„é›†åˆï¼ˆä¾‹å¦‚ï¼šä¸€ä¸ª `Vec` æˆ–è€…ä¸€ä¸ª `HashMap`ï¼‰ã€‚

å°½ç®¡ä¸ Rust æ²¡æœ‰ç›´æ¥å…³ç³»ï¼Œæˆ‘ä¹Ÿæ¨èé€šè¿‡  [reactivex.io](http://reactivex.io/) æ¥äº†è§£æ›´å¤šå…³äºæµçš„ä¼˜é›…ä¹‹å¤„å’Œå±€é™æ€§ã€‚

å¤šäºäº† [StreamExt](https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html) traitï¼Œä½ èƒ½å¤Ÿåœ¨æµä¸­ä½¿ç”¨ä¸è¿­ä»£å™¨ç›¸åŒçš„ç»„åˆå­ï¼Œæ¯”å¦‚ [filter](https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html#method.filter)ã€ [fold](https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html#method.fold)ã€ [for_each](https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html#method.for_each)ã€[map](https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html#method.map) ç­‰ç­‰ã€‚

å’Œè¿­ä»£å™¨ä¸€æ ·ï¼Œæµä¹Ÿéœ€è¦è¢«æ¶ˆè€—æ‰èƒ½äº§ç”Ÿæ•ˆæœã€‚

æ­¤å¤–ï¼Œè¿˜æœ‰ä¸€äº›ç‰¹å®šçš„ç»„åˆå­å¯ä»¥ç”¨æ¥å¹¶å‘å¤„ç†å…ƒç´ ï¼š

[for_each_concurrent](https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html#method.for_each_concurrent) å’Œ [buffer_unordered](https://docs.rs/futures/latest/futures/stream/trait.StreamExt.html#method.buffer_unordered)ã€‚

æ­£å¦‚ä½ æ³¨æ„åˆ°çš„é‚£æ ·ï¼Œä¸¤è€…ä¹‹é—´çš„åŒºåˆ«æ˜¯ `buffer_unordered` ç”Ÿæˆä¸€ä¸ªéœ€è¦è¢«æ¶ˆè€—çš„æµï¼Œè€Œ`for_each_concurrent` å®é™…ä¸Šæ¶ˆè€—äº†æµã€‚

ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š

```rust
use futures::{stream, StreamExt};
use rand::{thread_rng, Rng};
use std::time::Duration;

#[tokio::main(flavor = "multi_thread")]
async fn main() {
    stream::iter(0..200u64)
        .for_each_concurrent(20, |number| async move {
            let mut rng = thread_rng();
            let sleep_ms: u64 = rng.gen_range(0..20);
            tokio::time::sleep(Duration::from_millis(sleep_ms)).await;
            println!("{}", number);
        })
        .await;
}

```

```shell
$ cargo run --release
14
17
18
13
9
2
5
8
16
19
3
4
10
29
0
7
20
15
...
```

æ‰“å°çš„æ•°å­—çš„æ— åºæ€§ï¼Œè¡¨æ˜äº†ç¨‹åºæ˜¯å¹¶å‘æ‰§è¡Œçš„ã€‚

åœ¨ `async` Rust ä¸­ï¼Œæµå’Œç›¸åº”çš„å¹¶å‘ç»„åˆå­æ›¿ä»£äº†å…¶å®ƒè¯­è¨€ä¸­çš„å·¥ä½œæ± ã€‚å·¥ä½œæ± é€šå¸¸ç”¨äºå¹¶å‘å¤„ç†ä½œä¸šï¼Œæ¯”å¦‚ HTTP è¯·æ±‚ã€æ–‡ä»¶å“ˆå¸Œç­‰ã€‚ä½†åœ¨ Rust ä¸­ï¼Œå®ƒä»¬æ˜¯ä¸€ç§åé¢æ¨¡å¼ï¼ˆanti-patternï¼‰ï¼Œå› ä¸ºå®ƒä»¬çš„ api é€šå¸¸æ”¯æŒå‘½å‘½å¼ç¼–ç¨‹ã€å¯å˜å˜é‡(ç§¯ç´¯è®¡ç®—ç»“æœ)ï¼Œå› æ­¤å¯èƒ½ä¼šå¼•å…¥å¾®å¦™çš„ bug ã€‚

å®é™…ä¸Šï¼Œå·¥ä½œæ± æœ€å¸¸è§çš„æŒ‘æˆ˜æ˜¯æ”¶é›†åº”ç”¨åˆ°ä½œä¸šçš„è®¡ç®—çš„ç»“æœã€‚

æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥é€šè¿‡æµä»£æ›¿å·¥ä½œæ± ï¼Œå¹¶ä»¥ä¸€ç§åœ°é“çš„ã€å‡½æ•°å¼çš„æ–¹å¼æ”¶é›†ç»“æœã€‚è¯·è®°ä½ï¼Œ**å§‹ç»ˆè¦ä¸ºå¹¶å‘ä»»åŠ¡çš„æ•°é‡è®¾ç½®ä¸€ä¸ªä¸Šé™ã€‚å¦åˆ™ï¼Œå¯èƒ½ä¼šè¿…é€Ÿè€—å°½ç³»ç»Ÿçš„èµ„æºï¼Œä»è€Œå½±å“æ€§èƒ½ã€‚**

